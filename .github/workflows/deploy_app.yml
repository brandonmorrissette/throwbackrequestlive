name: Deploy App

on:
    workflow_call:
        secrets:
            AWS_ACCESS_KEY_ID:
                required: true
            AWS_SECRET_ACCESS_KEY:
                required: true
            AWS_REGION:
                required: true

jobs:
    deploy-network-stack:
        uses: ./.github/workflows/deploy_stack.yml
        name: Deploy Network Stack
        with:
            stack-name: NetworkStack
        secrets:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_REGION }}

    deploy-user-stack:
        uses: ./.github/workflows/deploy_stack.yml
        name: Deploy User Stack
        with:
            stack-name: UserStack
        secrets:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_REGION }}

    deploy-compute-stack:
        needs: deploy-network-stack
        name: Deploy Compute Stack
        uses: ./.github/workflows/deploy_stack.yml
        with:
            stack-name: ComputeStack
        secrets:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_REGION }}

    deploy-storage-stack:
        needs: deploy-network-stack
        name: Deploy Storage Stack
        uses: ./.github/workflows/deploy_stack.yml
        with:
            stack-name: StorageStack
        secrets:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_REGION }}

    deploy-runtime-stack:
        needs: [deploy-compute-stack, deploy-storage-stack]
        name: Deploy Runtime Stack
        uses: ./.github/workflows/deploy_stack.yml
        with:
            stack-name: RuntimeStack
        secrets:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_REGION }}

        deploy-superuser:
            name: Deploy Super User
            runs-on: ubuntu-latest
            steps:
                - name: Deploy Superuser
                uses: ./.github/workflows/deploy_superuser.yml
                with:
                    environment: production
                    superuser_email: ${{ vars.SUPERUSER_EMAIL }}
                env:
                    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                    AWS_REGION: ${{ secrets.AWS_REGION }}
    
        deploy-sql-files:
            name: Deploy SQL Files
            runs-on: ubuntu-latest
            steps:
                - name: Deploy SQL Files
                uses: ./.github/workflows/deploy_sql.yml
                with:
                    environment: production
                env:
                    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                    AWS_REGION: ${{ secrets.AWS_REGION }}

name: Deploy Stack with React instantiated

on:
    workflow_call:
        inputs:
            stack-name:
                required: true
                type: string
        secrets:
            AWS_ACCESS_KEY_ID:
                required: true
            AWS_SECRET_ACCESS_KEY:
                required: true
            AWS_REGION:
                required: true

jobs:
    deploy-runtime-stack:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '18'

            - name: Set up Python
              uses: actions/setup-python@v3
              with:
                  python-version: '3.12'

            - name: Install Dependencies
              run: |
                  npm install -g aws-cdk
                  pip install -r requirements.txt
                  pip install aws-cdk-lib constructs
                  npm install react-router-dom@6.2.1

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: CDK Bootstrap (if needed)
              run: cdk bootstrap || echo "Bootstrap already complete"

            - name: Set environment variables
              run: echo "ENVIRONMENT_NAME=Production" >> $GITHUB_ENV

            - name: Install and Build React
              run: |
                  cd frontend
                  npm install
                  npm run build
                  mv dist ../backend/webapp/static/react

            - name: Deploy Stack
              run: cdk deploy ${{ github.event.repository.name }}-${{ inputs.stack-name }}-${{ env.ENVIRONMENT_NAME }} --app "python backend/infra/app.py" --require-approval never
              env:
                  PROJECT_NAME: ${{ github.event.repository.name }}
                  ENVIRONMENT_NAME: ${{ env.ENVIRONMENT_NAME }}
